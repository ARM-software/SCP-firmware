\ingroup GroupModules Modules
\defgroup GroupApRemap AP Remap

Module AP Remap Design
======================

# Overview

The Manageability and System Control Processors (MSCP) in some of the Arm's
Reference Design platforms are based on 32-bit Cortex-M7 processor and can
address up to 4GB of address space. These sub-systems can also address the lower
2GB of the application processor's address space using the expansion ports that
are directly mapped into 2GB of the MSCP's address space. For accessing any
address above the lower 2GB address space of application processor or the
address space of other chips in multi-chip configuration, MSCP uses and an
address translation controller. The functionality of this controller and the
overall application processor addressing from MSCP is described below.

# Multi-chip AP Remap Overview

For all memory accesses generated by MSCP which falls within the System Access
Port window, the memory remapping applied to that address is illustrated below.

```
                                                   +------------------------------+
                                                   |          Remap to            |
                                                   | {ADDR_TRANS[47:20 bits],     +---------------------------->+
                                                   | Incoming address[19:0 bits]} |                             |
                                                   +--------------+---------------+                             |
                                                                  ^                                             |
                                                                  | Yes                                         |
                                                                  |                                             |
                                                       +----------+------------+                                |
                                                       |  Address in range     |    No                          |
                                                       |  {0x0_2B00_0000       +------------------------------->+
                                                       |  to 0x0_2B0F_ FFFF} + |                                |
                                                       |  4TB * CHIP_ID ?      |                                |
                                                       +---------+-------------+                                |
                                                                 ^                                              |
                     MSCP Memory Space                           |                                              |
                                                                 |                                              |
   0xFFFF_FFFF +--------------------------+                +-----+--------+                                     |
               |                          |                |  Address     |   No                                |
               |                          |                |  Translation +------------------------------------>+
               |                          |                |  enabled?    |                                     |
               |                          |                +-----+--------+                                     |
               |                          |                      ^                                              |
               |                          |                      |                                              |
               |                          |                      |                                              |
               |                          |        +-------------+-------------+ 0x3FFF_FFFF + 4TB * CHIP_ID    |
   0xE000_0000 +--------------------------+        |                           |                                |
               |                          |        | remap to 4TB * CHIP_ID +  |                                |
               |                          |        |       0GB to 1GB of       |                                |
               |   System Access Port 1   +------->+   Application Processor   |                                |
               |                          |        |       Memory Space        |                                |
               |                          |        +---------------------------+ 0x0000_0000 + 4TB * CHIP_ID    |
   0xA000_0000 +--------------------------+                                                                     |
               |                          |         +-----+--------+        +---------------------------+ 0x01_7FFF_FFFF + 4TB * CHIP_ID
               |                          |         |  CMN Addr    |  Yes   |                           |       |
               |   System Access Port 0   +-------->+  Translation +------->+ remap to 4TB * CHIP_ID +  |       |
               |                          |         |  enabled?    |        |       CMN Configuration   |       |
               |                          |         +-----+--------+        |       region in AP        |       |
   0x6000_0000 +--------------------------+               |                 |       Memory Space        |       |
               |                          |               |  No             +-------------+-------------+ 0x01_4000_0000 + 4TB * CHIP_ID
               |                          |               |                               |                     |
               |                          |               v                               |                     |
               |                          |         +-----+---------------------+ 0x7FFF_FFFF + 4TB * CHIP_ID   |
               |                          |         |                           |         |                     |
               |                          |         + remap to 4TB * CHIP_ID +  |         |                     |
               |                          |         |       1GB to 2GB of       |         |                     |
               |                          |         |   Application Processor   |         |                     |
               |                          |         |       Memory Space        |         |                     |
               |                          |         +-------------+-------------+ 0x4000_0000 + 4TB * CHIP_ID   |
               |                          |                       |                       |                     |
               |                          |                       |                       |                     |
   0x0000_0000 +--------------------------+                       |                       v                     |
                                                                  +-----------------------+---------------------+
                                                                  |
                                                                  |
                                                                  v
                                                            To Interconnect
```

    - MSCP to access the lower 2GB of the application processor memory space
      through the "System Access Port" window in the MSCP address space. The
      memory map of System Access Port window memory to the application
      processor memory map is shown below.

          System Access Port             Application Processor Memory Map
          ------------------             --------------------------------
          0x6000_0000 - 0x9FFF_FFFF  ->  0x4000_0000 - 0x7FFF_FFFF
          0xA000_0000 - 0xFFFF_FFFF  ->  0x0000_0000 - 0x3FFF_FFFF

    - MSCP to access 2GB and above address space of the local chip's application
      processor memory space or remote chip's application processor memory space.
      This is limited to 1MB access at a time.

# Module design

The AP Remap module provides the ability to configure the System Access Port
translations. A module that accesses the AP memory space, can bind to the AP
Remap module and access the memory location by using the `access_ap_memory()`
api.

1. For an address that falls within the first 2GB range of application processor
   memory space (System Access Port 0 or 1), the access is completed by the
   above defined memory translation.

2. For an address that falls above the 2GB range of application processor memory
   space, this function enables the AP Remap register from the MSCP PIK register
   space and uses the System Access Port 1's 1MB windowing range to access the
   required address.

The AP Remap results in changing the address passed to the bus and hence the
interrupts are disabled to enforce serialization between access to this API.

# Support for CMN AP Remap

On reference design platforms that map the CMN controller above 4GB of the
application processor address space, the `CMN_ATRANS_EN` bit in SCP PIK register
space allows the CMN controller to be mapped into MSCP addressable space.
Setting this bit will translate MSCP's `0x6000_0000 - 0x9FFF_FFFFF` to
`(4TB * CHIPID) + (CMN register offset)`

## Code Snippet

```c

access_ap_memory_1mb_window(uint64t addr):
        disable_interrupts();
        DSB()
        if(cmn_addr_trans_bit_set):
            disable_cmn_addr_trans();
        enable_addr_trans( with addr_47_20 )
        read(0x0_CB00_0000 + addr_19_0)
        //
        // or access_ap_memory(0x0_2B00_0000 + addr_19_0) but avoiding recursion
        // under critical section
        //
        DSB()
        if(cmn_addr_trans_bit_set):
            enable_cmn_addr_trans();
        enable_interrupts()


access_ap_memory(uint64t addr):
    if (addr >= 0x0_0000_0000 <= 0x0_3FFF_FFFF):           // first 1GB block
        read(addr + 0x0_A000_0000);
    else if (addr >= 0x0_4000_0000 <= 0x0_7FFF_FFFF):      // second 1GB block
        if(cmn_addr_trans_bit_set):
            disable_cmn_addr_trans();
        read(addr + 0x0_2000_0000)
        if(cmn_addr_trans_bit_set):
            enable_cmn_addr_trans();
    elseif (addr > 0x0_7FFF_FFFF):
        access_ap_memory_1mb_window(addr)
```
